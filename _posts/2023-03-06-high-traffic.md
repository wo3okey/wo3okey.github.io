---
layout: post
title: 그래서 대용량 트래픽은 어떻게 처리할까?
categories: [cs]
tags: [cs, 대용량트래픽]
---

`대용량 트래픽 처리`는 서버 개발자들의 면접 단골 질문이자, 서버 개발자들이라면 한번쯤 고민해보는 그 주제이다. 사실 주어진 환경과 시스템에 따라 처리할 수 있는 방향과 방법이 무궁무진하다. 때로는 매우 쉬운 조치만으로도 가능해질 수 있다면, 때로는 시스템 아키텍처 전체를 뒤엎어야 하는 대공사를 해야할 수 있다. 일반적으로 고려하면 좋을 방법들을 알아보자.

## 대용량 트래픽 처리
`대용량 트래픽`은 말 그대로 단위 시간의 수 많은 요청을 뜻한다. 구글이나 페이스북과 같은 기업들은 초당 수십억 건 이상의 요청이 올 수 있으며, 일반 국내 기업에서도 초당 수천에서 수만 이상의 요청이 올 수 있다. 어느정도 트래픽이 대용량일지 정의한 수치는 따로 없다. 그냥 내 개인적인 생각이라면, 인프라 또는 데브옵스 조직이 있는 회사라면 어느정도 시스템 규모 및 트래픽이 있고, 이에 따른 전체적인 시스템 및 트래픽 관리를 하는게 아닐까 싶다.

![HTTP protocol]({{site.url}}/assets/images/posts/high-traffic/high-traffic-01.png)

수천 수만의 대용량 트래픽을 단순하게 생각하면, 하나의 트래픽을 짧은 시간에 아주 많이 처리하는 것이다. 결국 하나의 트래픽은 하나의 네트워크 통신에 의해 처리된다. 즉, TCP/IP 통신간에 병목이 발생될 수 있는 부분을 찾고, 최적화 한다면 곧 대용량 트래픽을 처리할 수 있는 방법이 아닐까 싶다.

## Application Layer
개발자가 직접적으로 핸들링 할 영역이다. 대량의 요청에 대한 응답을 얼마나 빠르고 안정적으로 해결하느냐는 개발자의 숙명인 듯 하다.

### code
알게모르게 내가 개발해놓은 코드가 전체적인 네트워크 지연에 가장 큰 악영향을 끼칠 수 있다. 특히 시간복잡도가 O(n^2) 이상이거나 입력 크기가 큰 데이터를 처리해야 하는 로직이라면, 항시 리펙토링의 대상으로 경계 해야한다. 

### cache
일반적으로 mysql과 같은 DB는 하드디스크 기반의 데이터 스토리지이기 때문에 메모리에 비해서 훨씬 느린 속도로 데이터를 탐색한다. 그래서 반복되는 요청 리소스를 메모리 캐시를 통해 처리하여 서버 부하를 줄일 수 있다. 캐시는 일반적으로 redis와 같은 nosql을 활용할 수 있다.

![HTTP protocol]({{site.url}}/assets/images/posts/high-traffic/high-traffic-02.png)

캐시는 적용하고자 하는 도메인 데이터의 성질 local cache, global cache 전략중에 선택하면 된다.

* local cache: 기동중인 서버 내에 캐시 메모리를 사용하는 것이다. 사실상 오버헤드가 없다. 서버가 여러대면 각 서버마다 독립적인 캐시 메모리를 할당 받기 때문에 가장 빠르게 응답을 받을 수 있다. 다만 캐시의 동기화가 복잡할 수 있고, 각 서버간에 일관성이 깨질 수 있다.
* global cache: 여러대의 서버가 있다면, 별도의 캐시 서버두고 동기화된 메모리를 공유하는 것을 뜻한다. local cache에 비하면 동기화 문제는 없으나 네트워크 I/O 과정이 있기에 속도차이는 발생할 수 있다.

### CDN
### DB
### load balancer
### CQRS
L4, L7

## Transport Layer
### HTTP

## Internet Layer
### QoS
라우터 성능 최적화

QoS는 "Quality of Service"의 약어로서 기술과 네트워크 장비 두 가지 모두와 관련이 있습니다.
기술적으로 QoS는 네트워크 트래픽의 우선순위를 지정하고, 특정 트래픽 유형에 대한 대역폭 및 지연 시간 등의 서비스 품질(Quality of Service)을 보장하기 위한 기술입니다. QoS는 네트워크의 효율성과 안정성을 높이는 데에 중요한 역할을 합니다.
네트워크 장비 측면에서 QoS는 라우터, 스위치 등과 같은 네트워크 장비에서 구현됩니다. 이러한 장비에서는 QoS 설정을 통해 특정 트래픽 유형에 대한 우선순위를 설정하고, 대역폭과 지연 시간 등의 서비스 품질을 보장합니다.

## Network Layer

### scale in/out
뭐든 그렇듯 장비빨이 최고다. 트래픽 대군에 맞서 싸우기 위해 장비를 강화(sacle in)하거나 비슷한 장비를 여러개 장착(sacle out)하는 것을 선택해야 한다. 결국 대용량 트래픽을 처리 하기 위해 물리적인 전송 매체를 최적화 하는 방법을 고려해야 한다. 사실 가장 쉬운 방법은 성능이 빵빵한 장비를 사용하는 `sacle in`이다. 하지만 늘 그렇듯 좋은 장비는 비싸다. 그래서 일반적으로 가성비 좋은 장비를 여러대 장착시키는 형태의 `sacle out`을 많이 선택한다.

### bandwidth
그렇다면 장비를 얼마나 늘리면 되는걸까? 트래픽의 정도를 예측하기 위해서는 `대역폭(bandwidth)`을 계산 해야한다. 대역폭은 서버에서 전송 가능한 데이터의 양을 의미하며, 초당 전송 가능한 데이터의 양을 측정한 값이다. 즉, 서버가 어느정도의 대역폭이 확보되어 있냐에 따라 일단 대량의 요청을 버틸 수 있냐 없느냐가 결정 되는 것이다. 트래픽 대군이 몰려올때 맞서 싸울 아군의 전력이 얼마나 확충되어 있는지 말이다.