---
layout: post
title: 간단한 jenkins docker CI/CD 구성
categories: [cs]
tags: [clean architecture, 클린 아키텍처]
---

간단 ECS

# 최신 aws cli 설치
https://docs.aws.amazon.com/ko_kr/cli/latest/userguide/getting-started-install.html

# docker 설치
생략

# docker file 작성
적용할 springboot application에 Dockerfile 생성

# VPC, 서브넷 생성

# ECR 생성
![aws-ecs]({{site.url}}/assets/images/posts/jenkins-cicd/aws-ecs-01.png)

# ECR push
만약 권한 에러가 발생하면 보안자격을 등록하여 profile 옵션과 함께 push 명령어를 입력하면 된다.
* login
`aws ecr get-login-password --profile wookey --region ap-northeast-2 | docker login --username AWS --password-stdin 905418251008.dkr.ecr.ap-northeast-2.amazonaws.com`
* build image
`docker build -t springboot-lecture .`
* tag
`docker tag springboot-lecture:latest 905418251008.dkr.ecr.ap-northeast-2.amazonaws.com/springboot-lecture:latest`
* push
`docker push 905418251008.dkr.ecr.ap-northeast-2.amazonaws.com/springboot-lecture:latest`

## # access key 발급

# IAM역할 생성
IAM콘솔 > 역할 > 역할 만들기
1. 엔티티 유형 > AWS 서비스
2. 사용사례 > Elastic Container Service Task
3. 권한 경계 > AmazonECS_FullAccess
![aws-ecs]({{site.url}}/assets/images/posts/jenkins-cicd/aws-ecs-02.png)
4. 역할이름 > ecsFullAccessRole(편하게 지으면됨)
5. 역할생성

# 보안 그룹 설정
* 로드밸런서 보안규칙
EC2 > 보안 그룹 > 인바운드 규칙 > TCP 80, 443 포트 추가
![aws-ecs]({{site.url}}/assets/images/posts/jenkins-cicd/aws-ecs-03.png)

* application ec2 보안규칙
EC2 > 보안 그룹 > 인바운드 규칙 > TCP 필요한 포트 추가
![aws-ecs]({{site.url}}/assets/images/posts/jenkins-cicd/aws-ecs-04.png)

# ECS 클러스터 생성
Amazon Elastic Container Service > 클러스터 > 클러스터 생성

1. 클러스터 이름 짓기
2. 인프라 > Amazon EC2 인스턴스
  * autu scaling 그룹 설정해야함
  * fargate와 차이
![aws-ecs]({{site.url}}/assets/images/posts/jenkins-cicd/aws-ecs-06.png)
3. 네트워크 설정 > VPC 설정 및 private subnet 등록 > 로드밸런서 보안그룹 등록 > 퍼블릭IP 자동지정 끄기
![aws-ecs]({{site.url}}/assets/images/posts/jenkins-cicd/aws-ecs-07.png)
4. 모니터링 및 태그 생략 > 생성

# 로드밸랜서 ELB 생성
1. 로드밸런서 이름 설정
2. 위에서 만든 VPC 및 서브넷 네트워크 매핑
3. 위에서 만든 보안 그룹 매핑
4. 리스너 및 라우팅 > 대상 그룹 생성 > IP주소 > 대상 그룹 이름 설정 및 저장
![aws-ecs]({{site.url}}/assets/images/posts/jenkins-cicd/aws-ecs-05.png)
5. 대상 등록 > 인스턴스
6. 기 등록한 ECS 클러스터인 ECS Container Instance로 등록

# ECS 태스크 정의
Amazon Elastic Container Service > 클러스터 > 태스크 정의 > 새 태스크 정의 생성

기존 EC2의 OS/아키텍쳐와 t2.micro 인스턴스보다 적은 메모리를 설정해줬습니다.

0.5 vCPU, 1 GB로 구성

네트워크 모드는 4가지 모드가 존재하는데, Linux 환경에서의 일반적인 bridge를 선택했습니다.

awsvpc : Task를 호스팅하는 EC2에 ENI와 기본 프라이빗 IPv4 주소 할당, Fargate 사용 시 해당 모드를 선택해야 함
bridge : Task를 호스팅하는 EC2에 Linux에서의 docker의 기본 가상 네트워크 사용
default : Task를 호스팅하는 EC2에 Windows에서의 Docker 기본 가상 네트워크 이용
host : Task를 호스팅하는 EC2의 ENI에 직접 매핑 -> EC2 인스턴스 하나에서 동일 태스크에 대해 다중 인스턴스화 불가능

# ECS 클러스터 배포
Amazon Elastic Container Service > 클러스터 > 서비스 > 생성
* 배포 구성 > 태스크 > 방금 만든 task 패밀리 선택



* https://ksh-coding.tistory.com/134#2-2.%20Task%20%26%20Task%20Definition-1
* https://kobumddaring.tistory.com/76